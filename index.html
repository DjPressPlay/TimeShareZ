<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TimeShareZ</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <div class="app-container" id="app-root">
    <!-- All dynamic content, including the top bar, will be loaded here -->
  </div>

  <script type="module">
    import { initTutorialOverlay } from './script.js';
    import SessionManager from './sessionManager.js'; // Make sure to import the manager

    // An array defining the components and the order they should be loaded in
    const components = [
      "top-bar",
      "funded-feed",
      "hot-feed",
      "main-rotator",
      "tutorial-overlay",
      "footer"
    ];

    /**
     * Fetches and injects all HTML components into the app-root container.
     */
    async function loadComponents() {
      const root = document.getElementById("app-root");
      for (const name of components) {
        try {
          const response = await fetch(`components/${name}.html`);
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const html = await response.text();
          root.insertAdjacentHTML("beforeend", html);
        } catch (error) {
          console.error(`Error loading component ${name}.html:`, error);
          // Display a user-friendly error message within the app container
          root.insertAdjacentHTML("beforeend", `<p style="color:red; text-align:center;">Could not load a critical component. Please refresh.</p>`);
        }
      }
    }

    /**
     * Main function to initialize the entire application.
     * This controls the order of operations:
     * 1. Load UI components.
     * 2. Fetch data.
     * 3. Update UI with data.
     * 4. Initialize other scripts.
     */
    async function initializeApp() {
      // Step 1: Load all the visual components into the DOM
      await loadComponents();

      // Step 2: Get the session data using the SessionManager
      const sessionData = await SessionManager.getOrCreateSession();

      // Step 3: Find the session display element and update its content
      const sessionDisplayElement = document.getElementById("sessionDisplay");
      if (sessionDisplayElement) {
        if (sessionData && sessionData.session_number) {
          sessionDisplayElement.textContent = `Session ID = TSZ ${sessionData.session_number}`;
        } else {
          sessionDisplayElement.textContent = "Error: Could not get session";
          console.error("Failed to retrieve session data for display.");
        }
      }

      // Step 4: Now that everything is loaded and displayed, initialize other scripts
      initTutorialOverlay();
    }

    // Run the main application function
    initializeApp();
  </script>

</body>
</html>
